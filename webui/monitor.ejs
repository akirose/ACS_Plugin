<%- contentFor('head') %>
<script src="//cdn.jsdelivr.net/bluebird/3.4.0/bluebird.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script type="text/javascript">
	var current_plugin_pid = -1;

	$(document).ready(function() {
		var socket = io("/monitor");
		socket.on('connect', function() {
			socket.emit('greet', { type: 'monitor' });

			$('select#plugins > option:not(:first)').remove();
			$('div#chat-window > .panel-body').empty();
			$.chat('', 'Connected to monitor server.', 'info');
		});

		// plug-in information
		socket.on('plugin_info', function(plugin_info) {
			var plugins = $('select#plugins');
			var option = $("<option></option>")
							.attr('data-pid', plugin_info.pid)
							.attr('data-listen-port', plugin_info.options.listen_port)
							.val(plugin_info.pid)
							.text("#" + plugin_info.options.listen_port + " (PID:" + plugin_info.pid + ")");
			plugins.append(option);

			// sort by PID
			var options = plugins.find('option:not(:first)');
			options.sort(function(a, b) {
				var apid = Number(a.getAttribute('data-listen-port')),
					bpid = Number(b.getAttribute('data-listen-port'));
				if(apid > bpid) return 1;
				else if(bpid > apid) return -1;
				return 0;
			});
			options.detach().appendTo(plugins);

			// current session information
			this.emit('session_info', plugin_info.pid);
			new Promise(function(resolve, reject) {
					handler = function(pid, session_info) {
						if(plugin_info.pid === pid && session_info.session_index === session_info.current_session_index)  {
							resolve(session_info);
							socket.removeListener('session_info', handler);
						}
					};
					socket.on('session_info', handler);
				}).timeout(1000).error(function(error) {
					var option = $('select#plugins > option[value=' + plugin_info.pid + ']');
					option.text('#' + plugin_info.options.listen_port + ' (' + plugin_info.pid + ') - Not yet been connected.');
				}).finally(function() {
					socket.removeListener('session_info', handler);
				});
		});

		socket.on('plugin_disconnect', function(pid) {
			var plugins = $("select#plugins");
			var value = plugins.val();
			plugins.find('option[data-pid=' + pid + ']').remove();
			if(value !== plugins.val()) {
				plugins.trigger('change');
			}

			$.chat("server", "Stop plug-in (PID:" + pid + ")", "danger");
		});

		socket.on('new_connection', function(pid, car_info) {
			if(current_plugin_pid === -1 || current_plugin_pid === Number(pid)) {
				var server_name = $('select#plugins > option[value=' + pid + ']').attr('data-server-name');
				$.chat(pid, car_info.driver_name + ' is connected to ' + server_name, 'info');
			}
		});

		socket.on('connection_closed', function(pid, car_info) {
			if(current_plugin_pid === -1 || current_plugin_pid === Number(pid)) {
			}
		});

		socket.on('session_info', function(pid, session_info) {
			var option = $('select#plugins > option[value=' + pid + ']');
			option.attr('data-server-name', session_info.server_name);
			option.text('#' + option.attr('data-listen-port') + ' (' + pid + ') - ' + '[' + session_info.name + '] '+ session_info.server_name);

			if(current_plugin_pid === -1 || current_plugin_pid === Number(pid)) {
				$.chat('plugin-' + pid, session_info.server_name + ' - ' + session_info.name, 'info');
			}
		});

		socket.on('car_info', function(pid, car_info) {
			console.log(car_info);
		});

		socket.on('chat', function(pid, message, type) {
			$.chat('server', message, type);
		});

		$("#run_plugin_btn").click(function() {
			$("select#plugins > option:not(:first)").remove();
		});

		$("select#plugins").change(function() {
			var current_plugin_pid = Number(this.value);
		});

		// input chat message
		$("input#chat").keypress(function(event) {
			if(event.which == 13) {
				$("button#chat-send").trigger("click");
			}
		});
		$("button#chat-send").click(function() {
			if(current_plugin.index < 0) return;
			var chat = $("input#chat");
			var type = 'default';

			if($.trim(chat.val()).length === 0) return;

			if(chat.val().toString().indexOf('/') === 0) {
				socket.emit('send-plugin', current_plugin_pid, { command: 'admin_command', data: chat.val() });
				type = 'warning';
			} else {
				$.each($("select#chat-user").val(), function(index, car_id) {
					if(car_id >= 0) {
						socket.emit('send-plugin', current_plugin_pid, { command: 'privateChat', data: { car_id: car_id, message: chat.val() } });
					} else {
						socket.emit('send-plugin', current_plugin_pid, { command: 'broadcastChat', data: chat.val() });
					}
				});
			}
			$.chat('me', chat.val(), type);
			chat.val('');
		});
	});

	$.chat = function(from, message, type) {
		type = (typeof type === 'undefined') ? 'default' : type;
		var text = '';
		if(typeof message === 'object') {
			if(current_plugin.pid !== message.pid) {
				return;
			}
			text = message.text;
		} else {
			text = message;
		}

		var chatwindow = $("div#chat-window > .panel-body");
		var msg = $("<div></div>")
						.addClass('form-group')
						.append($("<label></label>")
									.addClass('control-label')
									.addClass('col-md-2')
									.text(from))
						.append($("<div></div>")
									.addClass('col-md-10')
									.append($("<p></p>")
										.addClass('form-control-static')
										.text(text)));
		msg.addClass('bg-' + type);

		if(chatwindow.find('div.form-group').size() > 100) {
			chatwindow.find('div.form-group:first').remove();
		}

		chatwindow.append(msg);

		var scrollheight = chatwindow.prop('scrollHeight');
		chatwindow.scrollTop(scrollheight);
	};
</script>
<%- contentFor('body') %>
<div class="panel panel-default">
	<div class="panel-heading">
		<div class="row form-horizontal">
			<label class="control-label col-md-1" for="plugins">Plug-in</label>
			<div class="col-md-5">
				<select id="plugins" class="form-control">
					<option data-pid="-1" value="-1">All</option>
				</select>
			</div>
		</div>
	</div>
	<div class="panel-body">
		<div class="row">
			<div class="col-md-3">
				<div class="form-group">
					<select id="chat-user" multiple class="form-control chat-user">
						<option value="-1" selected>All (Server message)</option>
					</select>
				</div>
				<div class="form-group">
					<div class="btn-group btn-group-justified" role="group">
						<div class="btn-group" role="group">
							<button type="button" class="btn btn-success">Ballast</button>
						</div>
						<div class="btn-group" role="group">
							<button type="button" class="btn btn-warning">Kick</button>
						</div>
						<div class="btn-group" role="group">
							<button type="button" class="btn btn-danger">Ban</button>
						</div>
					</div>
				</div>
			</div>
			<div class="col-md-9">
				<div id="chat-window" class="panel panel-default chat-window">
					<div class="panel-body form-horizontal">
					</div>
				</div>
				<div class="input-group">
					<input id="chat" type="text" class="form-control" />
					<span class="input-group-btn">
    					<button id="chat-send" class="btn btn-default" type="button">Send</button>
    				</span>
				</div>
			</div>
		</div>
	</div>
</div>